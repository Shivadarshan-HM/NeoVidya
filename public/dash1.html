<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NeoVidya – Login</title>
  <meta name="description" content="NeoVidya – playful, offline-friendly gamified learning login page for rural students." />
  <meta name="theme-color" content="#0F4C81" />
  <style>
    /* =====================
       NeoVidya – Design Tokens
       ===================== */
    :root {
      --nv-blue-900:#0F4C81;
      --nv-blue-700:#0B3A63;
      --nv-blue-600:#2D9CDB;
      --nv-yellow-500:#F4B400;
      --nv-green-600:#27AE60;
      --nv-coral-500:#FF6B6B;
      --nv-ink:#0C1220;
      --nv-paper:#F8F9FB;
      --nv-card:#0F355A;

      --radius-xl: 18px;
      --radius-2xl: 28px;
      --shadow-lg: 0 12px 32px rgba(7, 26, 46, 0.35);
      --shadow-sm: 0 6px 16px rgba(7, 26, 46, 0.2);

      --space-1: .5rem;
      --space-2: .75rem;
      --space-3: 1rem;
      --space-4: 1.25rem;
      --space-5: 1.75rem;
      --space-6: 2.25rem;

      --font-display: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --font-body: "Nunito", system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", "Helvetica Neue", Arial;

      --fg-light: #0C1220;
      --fg-dark: #E9F2FF;
      --bg-light: #EAF5FF;
      --bg-dark: #020817;
    }

    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin:0;
      color: var(--fg-dark);
      background: var(--bg-dark);
      font-family: var(--font-body);
      line-height: 1.5;
      transition: background 600ms ease, color 300ms ease;
      overflow: hidden; /* keep stars inside */
    }

    /* Sky canvas */
    .sky { position: fixed; inset: 0; z-index: -2; }
    .sun { position:absolute; width:220px; height:220px; border-radius:50%; right:7vw; top:7vh; background: radial-gradient(circle at 35% 35%, #fff9d6 0%, #ffe36b 40%, #ffd34a 60%, #ffd34a00 72%); box-shadow: 0 0 80px 30px #ffd34a88, 0 0 200px 60px #ffd34a55; animation: gentle 8s ease-in-out infinite; pointer-events:none; }
    .moon{ position:absolute; width:140px; height:140px; border-radius:50%; right:9vw; top:9vh; background: radial-gradient(circle at 30% 30%, #ffffff, #dfe6ff 60%, #a9b7ff 100%); box-shadow: 0 0 60px 20px #a9b7ff55, 0 0 140px 50px #7f93ff33; animation: gentle 9s ease-in-out infinite; filter: drop-shadow(0 8px 18px #0006); pointer-events:none; display:none; }
    .stars,.stars:before,.stars:after{ position:absolute; inset:0; content:""; display:none; }
    .stars{ width:2px; height:2px; box-shadow: 10vw 4vh #fff, 15vw 18vh #fff, 28vw 10vh #fff, 35vw 22vh #fff, 42vw 8vh #fff, 55vw 16vh #fff, 62vw 5vh #fff, 71vw 13vh #fff, 78vw 3vh #fff, 86vw 20vh #fff, 92vw 6vh #fff, 5vw 28vh #fff, 18vw 34vh #fff, 26vw 42vh #fff, 39vw 38vh #fff, 47vw 30vh #fff, 59vw 44vh #fff, 73vw 36vh #fff, 81vw 32vh #fff, 90vw 40vh #fff, 8vw 52vh #fff, 22vw 60vh #fff, 31vw 55vh #fff, 44vw 62vh #fff, 57vw 58vh #fff, 66vw 64vh #fff, 74vw 51vh #fff, 83vw 66vh #fff, 93vw 54vh #fff, 14vw 72vh #fff, 28vw 78vh #fff, 36vw 70vh #fff, 49vw 80vh #fff, 58vw 74vh #fff, 69vw 86vh #fff, 77vw 76vh #fff, 88vw 90vh #fff, 96vw 82vh #fff, 6vw 88vh #fff, 18vw 92vh #fff, 27vw 84vh #fff, 40vw 92vh #fff, 52vw 88vh #fff, 61vw 94vh #fff, 72vw 90vh #fff, 84vw 96vh #fff, 94vw 88vh #fff; animation: twinkle 3.2s infinite ease-in-out alternate; opacity:.95 }
    .stars:before{ width:1px; height:1px; box-shadow: 12vw 12vh #fff, 24vw 6vh #fff, 33vw 18vh #fff, 46vw 12vh #fff, 60vw 6vh #fff, 70vw 22vh #fff, 82vw 16vh #fff, 95vw 10vh #fff, 5vw 18vh #fff, 17vw 26vh #fff, 29vw 32vh #fff, 41vw 28vh #fff, 53vw 36vh #fff, 67vw 30vh #fff, 79vw 26vh #fff, 91vw 34vh #fff, 9vw 50vh #fff, 21vw 46vh #fff, 33vw 54vh #fff, 45vw 48vh #fff, 57vw 52vh #fff, 69vw 46vh #fff, 81vw 58vh #fff, 93vw 50vh #fff, 7vw 76vh #fff, 19vw 70vh #fff, 31vw 82vh #fff, 43vw 74vh #fff, 55vw 86vh #fff, 67vw 78vh #fff, 79vw 90vh #fff, 91vw 82vh #fff; }
    .stars:after{ width:3px; height:3px; box-shadow: 8vw 8vh #fff, 20vw 14vh #fff, 32vw 6vh #fff, 44vw 16vh #fff, 56vw 10vh #fff, 68vw 18vh #fff, 80vw 12vh #fff, 92vw 4vh #fff, 4vw 40vh #fff, 16vw 44vh #fff, 28vw 36vh #fff, 40vw 46vh #fff, 52vw 40vh #fff, 64vw 48vh #fff, 76vw 42vh #fff, 88vw 50vh #fff, 12vw 68vh #fff, 24vw 62vh #fff, 36vw 72vh #fff, 48vw 64vh #fff, 60vw 76vh #fff, 72vw 68vh #fff, 84vw 80vh #fff, 96vw 72vh #fff; }

    .sky.day { background: linear-gradient(180deg, #bde3ff 0%, var(--bg-light) 70%, #ffffff 100%); animation: sunrise 16s ease-in-out infinite alternate; }
    .sky.night { background: radial-gradient(1200px 600px at 50% 120%, #00122a, var(--bg-dark) 60%); animation: nightPulse 12s ease-in-out infinite alternate; }

    .theme-toggle { position: fixed; right: 18px; top: 18px; z-index: 5; border: 0; cursor: pointer; border-radius: 1000px; padding: 10px 14px; display:inline-flex; align-items:center; gap:10px; background: #ffffffcc; color:#222; backdrop-filter: blur(10px); box-shadow: 0 10px 24px #00000022, inset 0 1px 0 #ffffffcc; font-weight: 700; letter-spacing: .2px; transition: transform .15s ease, background 300ms ease; }
    .theme-toggle:active{ transform: translateY(1px) scale(.99); }
    .theme-toggle svg{ width:20px; height:20px; }

    body.theme-light { color: var(--fg-light); }
    body.theme-light .card { color: var(--fg-light); background: #ffffffd9; border-color: rgba(15, 53, 90, .12); }
    body.theme-light .input { color: var(--nv-ink); background: #f5f8ff; border-color: #d7e7ff; }
    body.theme-light .badge { background: rgba(15,76,129,.06); border-color: rgba(15,76,129,.18); color: #0B3A63; }
    body.theme-light .aux a { color: #0F4C81; border-bottom-color: rgba(15,76,129,.35); }

    body.theme-dark { color: var(--fg-dark); }

    .wrap { min-height: 100%; display: grid; grid-template-columns: 1.2fr 1fr; gap: var(--space-6); padding: clamp(16px, 3vw, 32px); position: relative; z-index: 0; }

    .hero { position: relative; border-radius: var(--radius-2xl); overflow: hidden; background:
        radial-gradient(600px 300px at 30% 25%, rgba(27,174,96,.20), transparent 70%),
        linear-gradient(160deg, rgba(13, 80, 138, .75), rgba(9, 48, 84, .85));
      box-shadow: var(--shadow-lg); display: grid; place-items: center; padding: clamp(16px, 4vw, 48px); isolation: isolate; }
    body.theme-light .hero{ background: linear-gradient(160deg, rgba(255,255,255,.65), rgba(255,255,255,.55)); }

    .badge-row { position: absolute; top: 16px; left: 16px; right: 16px; display: flex; gap: 10px; flex-wrap: wrap; opacity: .95; }
    .badge { background: rgba(255,255,255,.08); border: 1px dashed rgba(255,255,255,.25); padding: 6px 10px; border-radius: 999px; font-size: 12px; letter-spacing: .3px; display: inline-flex; align-items: center; gap: 6px; backdrop-filter: blur(4px); }
    .badge svg { width:14px; height:14px; }

    .hero-copy { text-align: center; max-width: 560px; }
    .title { font-family: var(--font-display); font-weight: 800; letter-spacing: .4px; font-size: clamp(28px, 4.2vw, 52px); margin: 0 0 var(--space-3); }
    .subtitle { margin: 0 auto var(--space-5); font-size: clamp(14px, 1.2vw, 18px); color: #D7E8FF; max-width: 46ch; }
    body.theme-light .subtitle{ color:#18324e }

    .mascot { width: clamp(220px, 36vw, 420px); filter: drop-shadow(0 10px 24px rgba(0,0,0,.35)); animation: floaty 6s ease-in-out infinite; }
    @keyframes floaty { 0%,100%{ transform: translateY(0)} 50%{ transform: translateY(-8px)} }
    .ear { transform-origin: 60% 40%; animation: earwiggle 3.6s ease-in-out infinite; }
    @keyframes earwiggle { 0%,100%{ transform: rotate(0deg)} 50%{ transform: rotate(-6deg)} }
    .eye { animation: blink 5s infinite; transform-origin: center; }
    @keyframes blink { 0%, 92%, 100% { transform: scaleY(1)} 96% { transform: scaleY(.1)} }

    .card { align-self: center; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border: 1px solid rgba(255,255,255,.12); border-radius: var(--radius-2xl); box-shadow: var(--shadow-lg); padding: clamp(18px, 3vw, 32px); backdrop-filter: blur(6px); }
    .brand { display: flex; align-items: center; gap: 10px; margin-bottom: var(--space-5); }
    .logo { width: 40px; height: 40px; border-radius: 10px; background: conic-gradient(from 210deg, var(--nv-yellow-500), var(--nv-green-600), var(--nv-blue-600), var(--nv-yellow-500)); box-shadow: inset 0 0 0 3px rgba(255,255,255,.25), 0 6px 16px rgba(0,0,0,.25); position: relative; }
    .logo::after{ content:""; position:absolute; inset:6px; border-radius: 8px; background: rgba(255,255,255,.25)}
    .brand h1 { font-family: var(--font-display); font-size: 22px; letter-spacing: .3px; margin:0 }
    .brand span { font-size: 12px; opacity: .85 }

    .field { display:grid; gap:6px; margin-bottom: var(--space-4); }
    label { font-size: 13px; color: #E6F0FF; }
    body.theme-light label{ color:#0B3A63 }
    .input { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.16); border-radius: var(--radius-xl); padding: 12px 14px; color: #fff; outline: none; transition: border .2s, box-shadow .2s, transform .1s; }
    .input:focus { border-color: var(--nv-blue-600); box-shadow: 0 0 0 4px rgba(45,156,219,.18); transform: translateY(-1px); }
    .row { display:flex; gap: var(--space-3); align-items: center; justify-content: space-between; }

    .btn { display:inline-flex; align-items:center; justify-content:center; gap:10px; width: 100%; border: none; cursor: pointer; border-radius: 14px; font-weight: 800; letter-spacing: .3px; padding: 12px 16px; background: linear-gradient(180deg, var(--nv-yellow-500), #D99C00); color: #1A1A1A; box-shadow: 0 10px 18px rgba(244,180,0,.25), inset 0 -4px 0 rgba(0,0,0,.15); transition: transform .06s ease, box-shadow .2s ease, filter .2s ease; }
    .btn:hover { filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); box-shadow: 0 6px 12px rgba(244,180,0,.25), inset 0 -2px 0 rgba(0,0,0,.18); }

    .aux { display:flex; justify-content: space-between; align-items:center; gap:8px; font-size: 13px; margin-top: 10px; }
    .aux a { color: #FFEC99; text-decoration: none; border-bottom: 1px dashed rgba(255,255,255,.35); padding-bottom:1px }
    .aux a:hover { color: #fff; }

    .meta-row { display:flex; gap:10px; align-items:center; margin-top: var(--space-5); font-size: 12px; opacity:.95 }
    .chip { background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.16); border-radius:999px; padding:6px 10px }
    body.theme-light .chip{ background:#eef6ff; border-color:#d7e7ff; color:#0B3A63 }

    .controls { display:flex; gap:10px; margin-top: var(--space-3); align-items:center }
    .toggle { display:inline-flex; align-items:center; gap:8px; font-size:13px; cursor:pointer }
    .switch { width:44px; height:26px; background: rgba(255,255,255,.22); border-radius: 999px; position:relative; transition: background .2s }
    .knob { position:absolute; top:3px; left:3px; width:20px; height:20px; background:#fff; border-radius:50%; transition: transform .2s }
    .switch.on { background: var(--nv-green-600) }
    .switch.on .knob { transform: translateX(18px) }

    @media (prefers-reduced-motion: reduce) { .mascot, .ear, .eye, .sun, .moon, .stars { animation: none !important; } }
    @media (max-width: 980px) { .wrap { grid-template-columns: 1fr; } .hero { order: 2; } .card { order: 1; } }

    @keyframes sunrise { 0% { background: linear-gradient(180deg, #76c8ff 0%, #bde3ff 40%, #ffffff 85%); } 100% { background: linear-gradient(180deg, #ffd1a1 0%, #ffe7c2 40%, #ffffff 85%); } }
    @keyframes nightPulse { 0%{ filter: brightness(1); } 100%{ filter: brightness(1.15); } }
    @keyframes twinkle { from { opacity: .65; transform: translateY(0px);} to { opacity: 1; transform: translateY(-1px);} }
    @keyframes gentle { 0%{ transform: translateY(0) rotate(-2deg) scale(1);} 50%{ transform: translateY(4px) rotate(2deg) scale(1.02);} 100%{ transform: translateY(0) rotate(-2deg) scale(1);} }
  </style>
</head>
<body class="theme-dark">
  <!-- Animated sky & celestial bodies -->
  <div id="sky" class="sky night" aria-hidden="true"></div>
  <div class="sun" aria-hidden="true"></div>
  <div class="moon" aria-hidden="true"></div>
  <div class="stars" aria-hidden="true"></div>

  <!-- Theme toggle (accessible) -->
  <button id="themeToggle" class="theme-toggle" aria-pressed="false" aria-label="Toggle dark mode">
    <svg id="iconSun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
    <svg id="iconMoon" style="display:none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
    <span id="toggleLabel">Dark</span>
  </button>

  <div class="wrap" role="main">
    <!-- Left: Playful Hero with Badges and Mascot -->
    <section class="hero" aria-label="NeoVidya playful welcome">
      <div class="badge-row" aria-hidden="true">
        <div class="badge">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2l2.9 5.9 6.5.9-4.7 4.6 1.1 6.5L12 17.8 6.2 20.9l1.1-6.5L2.6 8.8l6.5-.9L12 2z"/></svg>
          Level Up
        </div>
        <div class="badge">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2C7 2 3 6 3 11c0 6 5 10 9 10s9-4 9-10C21 6 17 2 12 2zm-.5 15c-2.8 0-5-2.2-5-5 0-1.1.3-2.1.9-3 1.7 1.2 3.3 2.3 4.9 3.5 1.3.9 2.6 1.9 3.9 2.8-.9 1.1-2.3 1.7-3.7 1.7z"/></svg>
          Grow Skills
        </div>
        <div class="badge">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2l7 3v6c0 5-3.7 9.8-7 11-3.3-1.2-7-6-7-11V5l7-3z"/></svg>
          Safe Space
        </div>
      </div>

      <div class="hero-copy">
        <h2 class="title">Welcome to NeoVidya</h2>
        <p class="subtitle">Learn with joy, level up your knowledge, and watch your progress tree grow — even offline.</p>

        <!-- Cute Mascot (unchanged) -->
        <!-- ... mascot SVG from your original kept ... -->
      </div>
    </section>

    <!-- Right: Login -->
    <section class="card" aria-label="Login form">
      <div class="brand" aria-label="NeoVidya brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>NeoVidya</h1>
          <span>Play • Learn • Grow</span>
        </div>
      </div>

      <form id="loginForm" novalidate>
        <div class="field">
          <label for="username">Username</label>
          <input class="input" id="username" name="username" type="text" inputmode="text" autocomplete="username" placeholder="Enter your username" required />
        </div>
        <div class="field">
          <label for="password">Password</label>
          <input class="input" id="password" name="password" type="password" autocomplete="current-password" placeholder="Enter your password" required />
        </div>

        <button class="btn" type="submit" aria-label="Sign in and start learning">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" style="color:#1A1A1A">
            <path d="M12 2l2 6 6 2-6 2-2 6-2-6-6-2 6-2z" />
          </svg>
          Start Your Adventure
        </button>

        <div class="aux" aria-label="Support links">
          <a href="forgetpass.html" id="forgot">Forgot password?</a>
          <a href="newaccountsignup.html" id="create">New here? Create account</a>
        </div>

        <div class="controls" aria-label="Fun settings">
          <label class="toggle" id="musicToggle">
            <div class="switch" role="switch" aria-checked="false" aria-label="Background music toggle"><span class="knob"></span></div>
            Music
          </label>
          <label class="toggle" id="sfxToggle">
            <div class="switch on" role="switch" aria-checked="true" aria-label="Sound effects toggle"><span class="knob"></span></div>
            SFX
          </label>
        </div>
      </form>
    </section>
  </div>

  <!-- Scripts -->
  <script>
  (function(){
    const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    // --------- THEME TOGGLE ---------
    const body = document.body;
    const sky = document.getElementById('sky');
    const btn = document.getElementById('themeToggle');
    const iconSun = document.getElementById('iconSun');
    const iconMoon = document.getElementById('iconMoon');
    const label = document.getElementById('toggleLabel');

    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const saved = localStorage.getItem('nv-theme');

    function setTheme(mode){
      const dark = mode === 'dark';
      body.classList.toggle('theme-dark', dark);
      body.classList.toggle('theme-light', !dark);
      sky.classList.toggle('night', dark);
      sky.classList.toggle('day', !dark);

      const sunEl = document.querySelector('.sun');
      const moonEl = document.querySelector('.moon');
      const starsEl = document.querySelector('.stars');
      if (sunEl) sunEl.style.display = dark ? 'none' : 'block';
      if (moonEl) moonEl.style.display = dark ? 'block' : 'none';
      if (starsEl) starsEl.style.display = dark ? 'block' : 'none';

      btn.setAttribute('aria-pressed', String(dark));
      iconSun.style.display = dark ? 'none' : 'block';
      iconMoon.style.display = dark ? 'block' : 'none';
      label.textContent = dark ? 'Dark' : 'Light';
      localStorage.setItem('nv-theme', mode);
    }

    setTheme(saved ? saved : (prefersDark ? 'dark' : 'light'));
    btn.addEventListener('click', ()=> setTheme(body.classList.contains('theme-dark') ? 'light' : 'dark'));

    // --------- Helpers
    const qs = (s, r=document) => r.querySelector(s);
    const musicSwitch = qs('#musicToggle .switch');
    const sfxSwitch = qs('#sfxToggle .switch');
    const form = qs('#loginForm');

    function toggleSwitch(el){
      const on = !el.classList.contains('on');
      el.classList.toggle('on', on);
      el.setAttribute('aria-checked', String(on));
      return on;
    }

    // --------- SFX
    let audioCtx; let melodyTimer;
    function makeCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); return audioCtx; }
    function beep(freq=880, time=0.08, type='sine', gain=.06){
      if(!sfxSwitch.classList.contains('on')) return;
      const ctx = makeCtx();
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type = type; o.frequency.value = freq; g.gain.value = gain;
      o.connect(g); g.connect(ctx.destination);
      o.start(); o.stop(ctx.currentTime + time);
    }
    function successJingle(){ const notes = [523,659,784]; notes.forEach((f,i)=> setTimeout(()=>beep(f, .12, 'triangle', .05), i*90)); }
    function startMelody(){
      if(!musicSwitch.classList.contains('on')) return;
      const ctx = makeCtx();
      const scale = [261.6,293.7,329.6,392.0,440.0,392.0,329.6,293.7];
      let i = 0; clearInterval(melodyTimer);
      melodyTimer = setInterval(()=>{
        const n = scale[i++ % scale.length];
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type = 'square'; o.frequency.value = n; g.gain.value = .015;
        o.connect(g); g.connect(ctx.destination);
        o.start(); o.stop(ctx.currentTime + 0.18);
      }, 240);
    }
    function stopMelody(){ clearInterval(melodyTimer); }

    musicSwitch.addEventListener('click', ()=>{ const on = toggleSwitch(musicSwitch); if(on){ startMelody(); } else { stopMelody(); } beep(on?660:440, .05, 'sine', .03); });
    sfxSwitch.addEventListener('click', ()=>{ const on = toggleSwitch(sfxSwitch); beep(on?700:350, .05, 'sine', .03); });
    [musicSwitch, sfxSwitch].forEach(sw=>{ sw.tabIndex=0; sw.addEventListener('keydown', (e)=>{ if(e.key===' '|| e.key==='Enter'){ e.preventDefault(); sw.click(); }}); });

    // --------- Form (FIXED)
    const username = qs('#username'); const password = qs('#password');
    [username, password].forEach(input=>{ input.addEventListener('focus', ()=> beep(660, .06, 'sine', .025)); });

   
  // ...keep your existing code above...

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const u = username.value.trim();
    const p = password.value.trim();

    if (!u || !p) {
      alert('Please fill in both Username and Password.');
      return;
    }

    // Send both possibilities: email and username
    const payload = { password: p };
    if (u.includes('@')) {
      payload.email = u;
    } else {
      payload.username = u;
      // also send as email for servers that only check email
      payload.email = u;
    }

    const apiBase = (location.protocol === 'file:' || location.port === '5500')
      ? 'http://localhost:3000'
      : '';

    try {
      const res = await fetch(`${apiBase}/api/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      let data = {};
      try { data = await res.json(); } catch {}

      if (res.ok && (data.token || data.user)) {
        // Save session
        localStorage.setItem('nv-auth', '1');
        if (data.token) localStorage.setItem('nv-token', data.token);
        localStorage.setItem('nv-user', JSON.stringify(data.user || { email: u, username: u }));

        // Go to dashboard
        window.location.href = 'neovidyadashboard.html';
      } else {
        const fallback = res.status === 404
          ? 'Login API not found. Make sure the backend is running on http://localhost:3000.'
          : 'Invalid username or password.';
        alert((data && (data.error || data.message)) || fallback);
      }
    } catch (err) {
      console.error(err);
      alert('Server error. Make sure the backend is running on http://localhost:3000.');
    }
  });

  // ...keep your existing code below...



    // Confetti stars (kept)
    function burstStars(anchor){
      const rect = anchor.getBoundingClientRect();
      const cx = rect.left + rect.width/2; const cy = rect.top + window.scrollY + rect.height/2;
      for(let i=0;i<14;i++){
        const s = document.createElement('div');
        s.setAttribute('aria-hidden','true');
        s.style.position='absolute'; s.style.left = cx + 'px'; s.style.top = cy + 'px';
        s.style.width = '8px'; s.style.height = '8px';
        s.style.background = i%3===0? 'var(--nv-yellow-500)': i%3===1? 'var(--nv-coral-500)': 'var(--nv-green-600)';
        s.style.clipPath = 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)';
        s.style.borderRadius='2px'; s.style.filter='drop-shadow(0 2px 4px rgba(0,0,0,.35))'; s.style.zIndex=9999; document.body.appendChild(s);
        const ang = Math.random()*Math.PI*2; const dist = 60 + Math.random()*40; const tx = Math.cos(ang)*dist; const ty = Math.sin(ang)*dist;
        s.animate(
          [{ transform: 'translate(-50%, -50%)', opacity: 1 },
           { transform: `translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px))`, opacity: 0 }],
          { duration: 600 + Math.random()*300, easing: 'cubic-bezier(.2,.8,.2,1)' }
        ).onfinish = ()=> s.remove();
      }
    }

    document.addEventListener('click', onceStart, { capture: true, once: true });
    function onceStart(){ if(musicSwitch.classList.contains('on')) startMelody(); }

    if(prefersReduced){ sfxSwitch.classList.remove('on'); sfxSwitch.setAttribute('aria-checked','false'); }
  })();
  </script>
</body>
</html>
